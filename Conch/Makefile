.PHONY: test run build build-js format format-perl format-perl deps\
	install-deps generate-dbic web-assets watch-js watch-perl watch doc\
	reset-database

test:
	@carton exec prove -j9 -lpr t/


run-perl:
	@carton exec ./local/bin/plackup -E development -s Starman --workers=50 -p 5001 -a bin/app.psgi

run: build run-perl

build: build-js web-assets doc

build-js: ui/package-lock.json
	@cd ui && npm run-script build;

format: format-perl format-js

# Exclude Schema files generated by dbicdump
format-perl:
	@find lib \
		-path lib/Conch/Schema -prune \
		-o -name "*.pm" -not -name "Schema*" -type f -exec perltidy {} +
	@find lib -name "*.bak" -delete

format-js:
	@cd ui && npm run prettier

web-assets: public/css/app.css public/js/app.js

ui/package-lock.json: ui/package.json
	@cd ui && npm install;
	@touch ui/package.json ui/package-lock.json

public/js/app.js: ui/bin/app.js
	@cp ui/bin/app.js public/js/app.js

public/css/app.css: ui/css/app.css
	@cp ui/css/app.css public/css/app.css

doc: public/doc/index.html

public/doc/index.html: docs/conch-api/openapi-spec.yaml
	@cd docs/conch-api && npm install && npm run render
	@mkdir -p public/doc
	@cp docs/conch-api/index.html public/doc/index.html

watch-js:
	@cd ui && npm start

watch-assets:
	@find ui/css/app.css ui/bin/app.js | entr -r make web-assets

watch-perl:
	@find lib | entr -r -c make run-perl

watch:
	(make watch-js &)
	(make watch-assets &)
	make watch-perl

deps: install-deps
install-deps:
	# '--deployment' installs the same dep versions that are in the lockfile
	@carton install --deployment

generate-dbic:
	@carton exec dbicdump schema.conf

reset-database:
	@../sql/reset-database.sh

