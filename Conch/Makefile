.PHONY: test run build build-js format format-perl format-perl deps\
	install-deps generate-dbic web-assets watch-js watch-perl watch doc\
	migrate-db watch-test

run: build
	@carton exec -- morbo -v bin/conch -l http://\*:5001

build: web-assets local doc

local: cpanfile.snapshot
# '--deployment' installs the same dep versions that are in the lockfile
	@carton install --deployment
	@touch local

test:
	@carton exec prove -lpr t/

format: format-perl format-js

# Exclude Schema files generated by dbicdump
format-perl:
	@find lib \
		-path lib/Conch/Legacy/Schema -prune \
		-o -name "*.pm" -not -name "Schema*" -type f -exec perltidy {} +
	@find lib -name "*.bak" -delete
	@find t -name "*.t"  -type f -exec perltidy {} +
	@find t -name "*.bak" -delete

format-js:
	@cd ui && yarn run prettier

web-assets: public/css/app.css public/js/app.js

public/js/app.js: ui/dist/main.js
	@cp ui/dist/main.js public/js/app.js

ui/dist/main.js: ui/node_modules ui/src/**
	@cd ui && yarn build;

ui/node_modules: ui/yarn.lock
	@cd ui && yarn install

ui/yarn.lock: ui/package.json
	@cd ui && yarn install
	@touch ui/package.json ui/yarn.lock

public/css/app.css: ui/css/app.css
	@cp ui/css/app.css public/css/app.css

doc: public/doc/index.html

public/doc/index.html: \
	docs/conch-api/openapi-spec.yaml \
	docs/conch-api/yarn.lock docs/conch-api/index.js
	@cd docs/conch-api && yarn install && yarn run render
	@mkdir -p public/doc
	@cp docs/conch-api/index.html public/doc/index.html

watch-js:
	@cd ui && yarn start

watch-assets:
	@find ui/css/app.css ui/dist/main.js | entr -r make web-assets

watch-perl:
	@find lib | entr -r -c make run

watch-test:
	@find lib t | entr -r -c make test

watch:
	(make watch-js &)
	(make watch-assets &)
	make watch-perl

generate-dbic:
	@carton exec dbicdump schema.conf

migrate-db:
	@../sql/run_migrations.sh

validation_docs: docs/validation/BaseValidation.md docs/validation/BaseValidation.md

# pod2github is installed with Pod::Github
docs/validation/BaseValidation.md: lib/Conch/Validation.pm
	@pod2github lib/Conch/Validation.pm > docs/validation/BaseValidation.md

docs/validation/TestingValidations.md: lib/Test/Conch/Validation.pm
	@pod2github lib/Test/Conch/Validation.pm > docs/validation/TestingValidations.md
